# 图片压缩工具 - 使用指南

## 📌 重要改进说明

### ✨ API Key 计数改进功能

本次更新重点加强了 **API Key 使用计数的持久化和可视化**，确保断点续传时能够准确继续计数。

#### 新增功能：

1. **详细的使用统计**
   - 每个 API key 的使用次数会实时保存到 `compression_log.json`
   - 记录每个 key 的首次使用时间和最后使用时间
   - 显示每个 key 的剩余可用次数
   - 使用进度条直观展示使用情况

2. **断点续传增强**
   - 每次压缩后立即保存日志，确保数据不丢失
   - 中断后重新运行，会从上次的计数继续
   - 自动恢复到上次使用的 API key
   - 保留历史总压缩次数统计

3. **可视化展示**
   - 程序启动时显示所有 API keys 的当前状态
   - 压缩完成后显示最新的使用统计
   - 每次压缩后显示当前 key 的剩余次数
   - 用进度条直观显示使用百分比

## 🚀 快速开始

### 1. 配置 API Keys

编辑 `config.json`，填入你的 TinyPNG API keys：

```json
{
    "api_keys": [
        "你的第一个API-key",
        "你的第二个API-key",
        "你的第三个API-key"
    ],
    "source_folder": "./images",
    "output_folder": "./compressed_images",
    "max_compressions_per_key": 500
}
```

### 2. 放置图片

将需要压缩的图片放入 `images` 文件夹（或你配置的源文件夹）。
支持多层嵌套文件夹结构。

### 3. 运行程序

```bash
python image_compressor.py
```

## 📊 运行界面示例

### 启动时显示

```
============================================================
图片压缩工具 - TinyPNG API
============================================================

============================================================
API Keys 使用状态详情
============================================================

Key 1 ← 当前使用
  标识: yrQZNvD6bR...g83
  使用: 0 / 500 (0.0%)
  进度: [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
  剩余: 500 次

Key 2
  标识: N4K7X7GSmT...DQY
  使用: 0 / 500 (0.0%)
  进度: [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
  剩余: 500 次

Key 3
  标识: hKwRc3wN1X...fk3
  使用: 0 / 500 (0.0%)
  进度: [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
  剩余: 500 次

============================================================
历史总压缩次数: 0
============================================================

开始扫描文件夹: ./images
找到 5 个图片文件
```

### 压缩过程中

```
[1/5] 处理: ./images/photo1.jpg
✓ 压缩成功: photo1.jpg
  原始大小: 2048.50 KB
  压缩后: 890.32 KB
  压缩率: 56.54%
  当前 Key 剩余次数: 499

[2/5] 处理: ./images/folder1/photo2.png
✓ 压缩成功: photo2.png
  原始大小: 1523.45 KB
  压缩后: 678.90 KB
  压缩率: 55.43%
  当前 Key 剩余次数: 498
```

### 完成后显示

```
============================================================
压缩完成！
============================================================
总文件数: 5
成功压缩: 5
跳过（已压缩）: 0
失败: 0
============================================================

============================================================
API Keys 使用状态详情
============================================================

Key 1 ← 当前使用
  标识: yrQZNvD6bR...g83
  使用: 5 / 500 (1.0%)
  进度: [█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
  剩余: 495 次
  首次使用: 2025-10-30 20:15:23
  最后使用: 2025-10-30 20:15:45

Key 2
  标识: N4K7X7GSmT...DQY
  使用: 0 / 500 (0.0%)
  进度: [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
  剩余: 500 次

Key 3
  标识: hKwRc3wN1X...fk3
  使用: 0 / 500 (0.0%)
  进度: [░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]
  剩余: 500 次

============================================================
历史总压缩次数: 5
上次运行时间: 2025-10-30 20:15:45
============================================================
```

## 📁 日志文件说明

### compression_log.json 结构

```json
{
    "compressed_files": {
        "文件MD5哈希": {
            "source_path": "源文件路径",
            "output_path": "输出文件路径",
            "original_size": 原始大小,
            "compressed_size": 压缩后大小,
            "compression_ratio": "压缩率",
            "compressed_at": "压缩时间",
            "api_key_index": 使用的key索引,
            "api_key_used": "使用的key标识"
        }
    },
    "key_usage": {
        "完整API-key": 使用次数
    },
    "key_details": {
        "完整API-key": {
            "first_used": "首次使用时间",
            "last_used": "最后使用时间",
            "total_usage": 总使用次数
        }
    },
    "current_key_index": 当前使用的key索引,
    "total_compressions": 历史总压缩次数,
    "last_run_time": "最后运行时间"
}
```

## 🔄 断点续传测试

### 测试场景

1. **运行程序压缩 100 张图片**
   ```bash
   python image_compressor.py
   ```
   此时 Key 1 使用次数：100

2. **中断程序（Ctrl+C）**

3. **再次运行程序**
   ```bash
   python image_compressor.py
   ```
   
   启动时会显示：
   ```
   Key 1 ← 当前使用
     标识: yrQZNvD6bR...g83
     使用: 100 / 500 (20.0%)
     进度: [██████░░░░░░░░░░░░░░░░░░░░░░░░]
     剩余: 400 次
     首次使用: 2025-10-30 20:00:00
     最后使用: 2025-10-30 20:10:00
   ```

4. **继续压缩**
   - 已压缩的 100 张图片会被跳过
   - 继续使用 Key 1 的剩余 400 次
   - 达到 500 次后自动切换到 Key 2

## ⚙️ 配置说明

### config.json 参数

- **api_keys**: API keys 列表
  - 可以配置多个 key
  - 程序会按顺序使用
  - 每个达到上限后自动切换下一个

- **source_folder**: 源图片文件夹
  - 支持相对路径和绝对路径
  - 例如：`"./images"` 或 `"D:/my_photos"`

- **output_folder**: 输出文件夹
  - 保持原目录结构
  - 例如：`"./compressed_images"`

- **max_compressions_per_key**: 每个 key 的使用上限
  - 默认：500（TinyPNG 免费额度）
  - 可根据你的订阅调整

- **supported_formats**: 支持的图片格式
  - 默认：`[".jpg", ".jpeg", ".png", ".webp"]`

## 💡 使用技巧

1. **多个 API Keys**
   - 注册多个账号获取多个免费 key
   - 每个 key 每月 500 次免费额度
   - 3 个 key = 1500 张图片/月

2. **断点续传**
   - 不用担心程序中断
   - 所有计数都会保存
   - 重新运行时自动继续

3. **批量处理**
   - 将大量图片放入文件夹
   - 支持任意层级的子文件夹
   - 程序会自动遍历所有文件

4. **重新压缩**
   - 如需重新压缩所有图片
   - 删除 `compression_log.json` 文件
   - 重新运行程序即可

## 🛠️ 故障排除

### API key 无效
- 检查 config.json 中的 key 是否正确
- 访问 https://tinypng.com/dashboard 查看 key 状态

### 网络错误
- 检查网络连接
- 确认可以访问 tinypng.com

### 文件路径错误
- 使用绝对路径更可靠
- 确保路径中没有特殊字符

## 📝 更新日志

### v2.0 (2025-10-30)
- ✨ 增强 API key 使用计数的持久化
- ✨ 新增详细的使用统计显示
- ✨ 新增进度条可视化
- ✨ 记录每个 key 的首次和最后使用时间
- ✨ 显示历史总压缩次数
- ✨ 每次压缩后显示当前 key 剩余次数
- 🐛 修复断点续传时计数可能不准确的问题
- 🐛 优化日志保存机制，确保数据实时保存

### v1.0 (2025-10-30)
- 🎉 首次发布
- 支持批量压缩
- 支持断点续传
- 支持多 API key 自动切换

