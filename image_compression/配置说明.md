# 配置说明

## config.json 配置项详解

```json
{
    "api_keys": [
        "your-api-key-1",
        "your-api-key-2",
        "your-api-key-3"
    ],
    "source_folder": "./images",
    "output_folder": "./compressed_images",
    "max_compressions_per_key": 500,
    "max_width": 1920,
    "enable_resize": true,
    "supported_formats": [".jpg", ".jpeg", ".png", ".webp"]
}
```

## 配置项说明

### 基础配置

#### `api_keys` (必填)
- **类型**: 字符串数组
- **说明**: TinyPNG API keys 列表
- **获取方式**: https://tinypng.com/developers
- **示例**: `["yrQZNvD6bRM...", "N4K7X7GSmT..."]`
- **注意**: 
  - 每个 key 每月有 500 次免费额度
  - 程序会自动轮换使用
  - 可以添加多个 key 增加可用次数

#### `source_folder` (必填)
- **类型**: 字符串
- **说明**: 需要压缩的图片源文件夹
- **支持**: 相对路径或绝对路径
- **示例**: 
  - `"./images"` (相对路径)
  - `"D:/my_photos"` (绝对路径)
  - `"F:/2025/photos"` (绝对路径)

#### `output_folder` (必填)
- **类型**: 字符串
- **说明**: 压缩后图片的输出文件夹
- **特点**: 保持原目录结构
- **示例**: `"./compressed_images"`

#### `max_compressions_per_key` (可选)
- **类型**: 整数
- **默认值**: 500
- **说明**: 每个 API key 的最大使用次数
- **注意**: TinyPNG 免费额度为 500 次/月，如果购买了付费版可以调整

### 🆕 图片预处理配置

#### `max_width` (可选) ⭐ 新功能
- **类型**: 整数
- **默认值**: 1920
- **说明**: 图片最大宽度（像素）
- **作用**: 
  - 当图片宽度超过此值时，先在本地进行等比缩放
  - 缩放后再调用 TinyPNG API 压缩
  - 可以大幅减小文件体积，节省 API 使用次数
- **推荐值**:
  - 网页展示: `1920` 或 `1440`
  - 移动端: `1080` 或 `750`
  - 高清展示: `2560` 或 `3840`
- **示例**: `"max_width": 1920`

#### `enable_resize` (可选) ⭐ 新功能
- **类型**: 布尔值
- **默认值**: true
- **说明**: 是否启用本地缩放功能
- **选项**:
  - `true`: 启用本地缩放，超过 max_width 的图片会先缩放
  - `false`: 禁用缩放，直接使用原图调用 API
- **建议**: 
  - 对于超大图片（如相机原图），建议启用此功能
  - 可以大幅节省压缩时间和 API 次数

### 其他配置

#### `supported_formats` (可选)
- **类型**: 字符串数组
- **默认值**: `[".jpg", ".jpeg", ".png", ".webp"]`
- **说明**: 支持的图片格式列表
- **注意**: 格式需要以点(.)开头且小写

## 使用场景示例

### 场景 1: 压缩网站图片
```json
{
    "max_width": 1920,
    "enable_resize": true
}
```
适合网站展示，1920px 宽度对于大部分屏幕已经足够清晰。

### 场景 2: 压缩移动端图片
```json
{
    "max_width": 1080,
    "enable_resize": true
}
```
移动端展示不需要太大尺寸，1080px 足够。

### 场景 3: 保持原尺寸
```json
{
    "max_width": 1920,
    "enable_resize": false
}
```
不进行缩放，直接压缩原图（适合需要保持原尺寸的场景）。

### 场景 4: 处理相机原图
```json
{
    "max_width": 2560,
    "enable_resize": true
}
```
相机拍摄的照片通常是 4000-6000px，缩放到 2560px 后再压缩效果更好。

## 工作流程

启用 `enable_resize` 后的处理流程：

```
1. 读取源图片
   ↓
2. 检查图片宽度
   ↓
3. 如果宽度 > max_width
   → 本地等比缩放到 max_width
   → 保存到临时文件
   ↓
4. 调用 TinyPNG API 压缩
   ↓
5. 保存到输出文件夹
   ↓
6. 清理临时文件
   ↓
7. 记录使用次数
```

## 示例输出

启用缩放功能后的输出示例：

```
[1/5] 处理: ./images/photo.jpg
  本地缩放: 4032x3024 -> 1920x1440
✓ 压缩成功: photo.jpg
  原始大小: 3256.50 KB
  压缩后: 456.32 KB
  压缩率: 85.99%
  当前 Key 剩余次数: 499
```

## 注意事项

1. **缩放质量**: 
   - 使用 Pillow 的 LANCZOS 算法，保证高质量缩放
   - JPEG 保存质量设置为 95，保证良好的图片质量

2. **临时文件**: 
   - 缩放后的图片会保存到系统临时目录
   - 压缩完成后会自动清理

3. **性能影响**:
   - 本地缩放速度很快（秒级）
   - 对于超大图片，缩放后再上传可以节省网络传输时间

4. **压缩率计算**:
   - 显示的压缩率是基于原始文件大小计算的
   - 包含了本地缩放和 API 压缩的总效果

## 常见问题

### Q: 缩放会影响图片质量吗？
A: 使用高质量的 LANCZOS 算法，在大部分场景下肉眼难以察觉差异。如果需要绝对保持原尺寸，可以将 `enable_resize` 设为 false。

### Q: 应该设置多大的 max_width？
A: 取决于使用场景：
- 网页展示：1920-2560px
- 移动端：1080-1440px
- 打印或高清展示：保持原图或使用较大值如 3840px

### Q: 缩放功能会增加处理时间吗？
A: 本地缩放速度很快，对于超大图片（如 6000px 宽），缩放后再上传 API 反而会更快。

### Q: 可以只缩放不调用 API 吗？
A: 当前版本需要配合 API 使用。如果只需要缩放，建议使用专门的批量图片缩放工具。

